# PostgreSQL: Using the EXPLAIN Command

The **EXPLAIN** command in PostgreSQL is used to inspect the **query plan** generated by the Planner component. It helps understand how PostgreSQL intends to execute a query and can be invaluable for performance tuning.

---

## 1. Purpose of EXPLAIN

* Shows the **query plan** without executing the query (unless `ANALYZE` is used).
* Helps identify **bottlenecks** in query execution.
* Can be used with visual tools (e.g., [explain.depesz.com](https://explain.depesz.com)) to make interpretation easier.

**Memory Hook:** “EXPLAIN lets you peek behind the scenes of PostgreSQL’s query execution.”

---

## 2. How EXPLAIN Works

1. The client submits the `EXPLAIN` command along with a SQL query.
2. The query passes through **all query processing stages** **except execution**.
3. The Planner generates a **query plan tree**, which is returned to the client in **textual format**.

---

## 3. EXPLAIN Options

| Option    | Description                                                                 |
| --------- | --------------------------------------------------------------------------- |
| `ANALYZE` | Executes the query and shows **actual run statistics** along with the plan. |
| `COSTS`   | Show or hide **startup and total costs** (default: on).                     |
| `BUFFERS` | Shows buffer usage; works **only with ANALYZE**.                            |
| `FORMAT`  | Output format: `TEXT` (default), `JSON`, `XML`, or `YAML`.                  |
| `VERBOSE` | Prints additional details about plan nodes.                                 |

---

## 4. Understanding Plan Node Output

Each **line in EXPLAIN output** represents a **plan node**. The key details include:

| Field                 | Meaning                                                             |
| --------------------- | ------------------------------------------------------------------- |
| Node Type             | Operation performed (e.g., Seq Scan, Hash Join, Aggregate).         |
| Startup Cost          | Cost before the first row can be returned.                          |
| Total Cost            | Estimated cost to execute the node completely.                      |
| Rows (Estimated)      | Number of rows expected to be returned by the node.                 |
| Actual Rows (ANALYZE) | Number of rows actually returned (if ANALYZE is used).              |
| Loops                 | Number of times this node was executed (relevant for nested loops). |
| Buffers (ANALYZE)     | Number of disk buffers hit/read (if BUFFERS option is on).          |

**Memory Hook:** “Startup cost is the preamble, total cost is the full story.”

---

### 4.1 Cost Explanation

* **Startup Cost:** Effort to prepare the node for returning the first row.

  * Example: Sorting an unindexed column involves pre-sorting before returning rows.
* **Total Cost:** Aggregate cost for the node, including all child nodes in the plan tree.
* **Deviation:** If `ANALYZE` is used, PostgreSQL compares **estimated vs actual** rows.

  * Significant deviation may indicate **outdated statistics**.

---

## 5. Example: Interpreting EXPLAIN Output

* The output is **hierarchical**, representing the plan tree.
* A `->` prefix indicates the node in the tree.
* Example fields: `Node Type`, `Exclusive Time` (time for node itself), `Inclusive Time` (time including child nodes), `Estimated Rows`, `Actual Rows`.

**Tips:**

* **Up arrow:** Planner **overestimated** rows.
* **Down arrow:** Planner **underestimated** rows.
* Large differences → Consider **regenerating table statistics** using `ANALYZE`.

---

## 6. Visualizing Query Plans

* Tools like [explain.depesz.com](https://explain.depesz.com) can **visualize EXPLAIN output**.
* Steps:

  1. Run `EXPLAIN ANALYZE <your_query>` in PostgreSQL.
  2. Copy the output to the tool.
  3. Submit → see **tree layout, costs, rows, and buffer usage** visually.

**Memory Hook:** “Visualization turns textual plans into a clear roadmap of query execution.”

---

## 7. Best Practices

* Always check **estimated vs actual rows** when tuning queries.
* Use **EXPLAIN ANALYZE** to capture real execution statistics.
* Consider **updating statistics** (`ANALYZE table`) if deviations are large.
* Explore **plan nodes** individually to understand operations (e.g., Hash Aggregate, Seq Scan, Nested Loop).

---

## 8. FAQ

**Q1: Does EXPLAIN execute the query?**

* Only if `ANALYZE` is used. Without it, EXPLAIN shows the **planned query**.

**Q2: What do `Startup Cost` and `Total Cost` mean?**

* Startup Cost: Effort to begin returning the first row.
* Total Cost: Total estimated cost for executing the node and its children.

**Q3: How do I know if table statistics are outdated?**

* Large differences between **estimated vs actual rows** indicate that statistics may need regeneration.

**Q4: Can EXPLAIN help with indexing decisions?**

* Yes — the plan shows if PostgreSQL is using **sequential scans, index scans, or joins**, guiding indexing strategies.

